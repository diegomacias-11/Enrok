{% extends "form.html" %}

{% block form_container_classes %}dispersiones-form{% endblock %}

{% block title %}{% if dispersion %}Editar Dispersión{% else %}Nueva Dispersión{% endif %}{% endblock %}

{% block back_link %}
  <section class="filter-container">
    <a href="{{ back_url|default_if_none:'' }}" class="btn-filter">Volver</a>
  </section>
{% endblock %}

{% block form_fields %}
  <input type="hidden" name="next" value="{{ back_url|default_if_none:'' }}">
  <input type="hidden" name="mes" value="{{ mes|default_if_none:'' }}">
  <input type="hidden" name="anio" value="{{ anio|default_if_none:'' }}">

  <div class="form-grid">
    <div class="form-col">
      <label for="{{ form.fecha.id_for_label }}">Fecha</label>
      {{ form.fecha }}

      <label for="{{ form.cliente.id_for_label }}">Cliente</label>
      {{ form.cliente|default_if_none:"" }}

      <label>Servicio</label>
      <input type="text" id="cliente-servicio" value="{{ cliente_info.servicio|default_if_none:'' }}" disabled>

      <label>Comisión servicio</label>
      <input type="text" id="cliente-comision" value="{{ cliente_info.comision_servicio|default_if_none:'' }}" disabled>

      <label for="{{ form.ejecutivo.id_for_label }}">Ejecutivo</label>
      {{ form.ejecutivo|default_if_none:"" }}

      <label for="{{ form.comentarios.id_for_label }}">Comentarios</label>
      {{ form.comentarios|default_if_none:"" }}
    </div>

    <div class="form-col">
      <label for="{{ form.num_periodo.id_for_label }}">No. periodo</label>
      {{ form.num_periodo|default_if_none:"" }}

      <label for="{{ form.monto_dispersion.id_for_label }}">Monto dispersión</label>
      <div class="input-currency">{{ form.monto_dispersion|default_if_none:"" }}</div>

      {% if dispersion %}
      <label for="{{ form.monto_comision_iva.id_for_label }}">Comisión + IVA</label>
      <div class="input-currency">{{ form.monto_comision_iva|default_if_none:"" }}</div>
      {% endif %}

      <label for="{{ form.ac.id_for_label }}">AC</label>
      <input type="text" id="cliente-ac" value="{{ cliente_info.ac|default_if_none:'' }}" disabled>

      <label for="{{ form.num_factura.id_for_label }}">No. factura</label>
      {{ form.num_factura|default_if_none:"" }}

      <label for="{{ form.facturadora.id_for_label }}">Facturadora</label>
      {{ form.facturadora|default_if_none:"" }}

      <label for="{{ form.num_factura_honorarios.id_for_label }}">No. factura honorarios</label>
      {{ form.num_factura_honorarios|default_if_none:"" }}
    </div>

    <div class="form-col">
      <label for="{{ form.estatus_proceso.id_for_label }}">Estatus proceso</label>
      {{ form.estatus_proceso|default_if_none:"" }}

      <label for="{{ form.estatus_periodo.id_for_label }}">Estatus periodo</label>
      {{ form.estatus_periodo|default_if_none:"" }}

      <label for="{{ form.estatus_pago.id_for_label }}">Estatus pago</label>
      {{ form.estatus_pago|default_if_none:"" }}
    </div>
  </div>
{% endblock %}

{% block extra_actions %}
  {% if dispersion %}
    <button type="submit"
            class="btn-delete"
            formaction="{% url 'dispersiones_delete' dispersion.id %}"
            formmethod="post"
            onclick="return confirm('¿Eliminar esta dispersión?');">
      Eliminar
    </button>
  {% endif %}
{% endblock %}

{% block extra_scripts %}
  <script>
    (function () {
      var clienteSelect = document.getElementById("{{ form.cliente.id_for_label }}");
      if (!clienteSelect) {
        return;
      }
      var acInput = document.getElementById("cliente-ac");
      var servicioInput = document.getElementById("cliente-servicio");
      var comisionInput = document.getElementById("cliente-comision");
      var ejecutivoSelect = document.getElementById("{{ form.ejecutivo.id_for_label }}");
      var isEditing = {{ dispersion|yesno:"true,false" }};

      function applyFromSelected() {
        var opt = clienteSelect.options[clienteSelect.selectedIndex];
        if (!opt) {
          return;
        }
        var data = opt.dataset || {};
        if (acInput) acInput.value = data.ac || "";
        if (servicioInput) servicioInput.value = data.servicio || "";
        if (comisionInput) comisionInput.value = data.comision || "";
        if (ejecutivoSelect && !isEditing && !ejecutivoSelect.value) {
          ejecutivoSelect.value = data.ejecutivoId || "";
        }
      }

      clienteSelect.addEventListener("change", applyFromSelected);
      applyFromSelected();
    })();
  </script>
{% endblock %}
