{% extends "kanban_base.html" %}
{% load cliente_extras %}

{% block title %}Dispersiones (Kanban){% endblock %}

{% block filtros %}
  <div class="filter-title">{{ mes_nombre|default_if_none:"" }} {{ anio|default_if_none:"" }}</div>
  <div class="metrics-row metrics-row-compact">
    <div class="metric">
      <div class="metric-label">Total dispersiones</div>
      <div class="metric-value">{{ total_dispersiones|default_if_none:"0" }}</div>
    </div>
    <div class="metric">
      <div class="metric-label">Total dispersado</div>
      <div class="metric-value">{{ total_dispersado|default_if_none:""|currency }}</div>
    </div>
    <div class="metric">
      <div class="metric-label">Monto facturado</div>
      <div class="metric-value">{{ total_facturado|default_if_none:""|currency }}</div>
    </div>
  </div>
  <div class="filter-bar">
    <div class="filter-slot filter-slot-left">
      <a class="btn-primary btn-primary-inline btn-view" href="{% url 'dispersiones_list' %}?mes={{ mes }}&anio={{ anio }}">Vista</a>
    </div>
    <div class="filter-slot filter-slot-center">
      <form method="get" class="filter-form-simple kanban-filter dispersiones-filter">
        <div class="filter-block">
          <label for="mes">Mes</label>
          <select id="mes" name="mes">
            {% if meses_choices %}
              {% for m, nombre in meses_choices %}
                <option value="{{ m }}" {% if mes == m|stringformat:'i' %}selected{% endif %}>{{ nombre }}</option>
              {% endfor %}
            {% else %}
              {% for m in meses %}
                <option value="{{ m }}" {% if mes == m|stringformat:'i' %}selected{% endif %}>{{ m|stringformat:"02d" }}</option>
              {% endfor %}
            {% endif %}
          </select>
        </div>
        <span class="filter-separator" aria-hidden="true"></span>
        <div class="filter-block">
          <label for="anio">AÃ±o</label>
          <input type="number" id="anio" name="anio" value="{{ anio|default_if_none:'' }}" min="2000" max="2100">
        </div>
        <span class="filter-separator" aria-hidden="true"></span>
        <div class="filter-block">
          <label for="f_cliente">Cliente</label>
          <select id="f_cliente" name="cliente">
            <option value="">Todos</option>
            {% for c in clientes %}
              <option value="{{ c.id }}" {% if f_cliente == c.id|stringformat:'i' %}selected{% endif %}>{{ c.razon_social }}</option>
            {% endfor %}
          </select>
        </div>
        <span class="filter-separator" aria-hidden="true"></span>
        <div class="filter-block">
          <label for="f_ejecutivo">Ejecutivo</label>
          <select id="f_ejecutivo" name="ejecutivo">
            <option value="">Todos</option>
            {% for id, name in ejecutivos %}
              <option value="{{ id }}" {% if f_ejecutivo == id|stringformat:'i' %}selected{% endif %}>{{ name }}</option>
            {% endfor %}
          </select>
        </div>
        <span class="filter-separator" aria-hidden="true"></span>
        <div class="filter-block">
          <label for="f_factura_solicitada">Factura solicitada</label>
          <select id="f_factura_solicitada" name="factura_solicitada">
            <option value="">Todos</option>
            <option value="1" {% if f_factura_solicitada == "1" %}selected{% endif %}>Si</option>
            <option value="0" {% if f_factura_solicitada == "0" %}selected{% endif %}>No</option>
          </select>
        </div>
        <span class="filter-separator" aria-hidden="true"></span>
        <div class="filter-actions">
          <button type="submit" class="btn-filter">Filtrar</button>
          <a href="{% url 'dispersiones_kanban' %}?mes={{ mes }}&anio={{ anio }}" class="btn-filter">Limpiar</a>
        </div>
      </form>
    </div>
    <div class="filter-slot filter-slot-right"></div>
  </div>
{% endblock %}


{% block kanban_content %}
  <div class="kanban-board">
    {% for bloque in kanban_data %}
      <div class="kanban-column {% if bloque.status_class %}{{ bloque.status_class }}{% endif %}">
        <div class="kanban-column-title">{{ bloque.titulo }}</div>
        {% for grupo in bloque.clientes %}
          <details class="kanban-area">
            <summary class="kanban-area-title">{{ grupo.cliente }}</summary>
            {% if grupo.items %}
              {% for item in grupo.items %}
                <div class="kanban-card">
                  <div class="kanban-card-body">
                    <div class="kanban-task">{{ item.fecha|date:"d/m/Y" }}</div>
                    <div class="kanban-meta">Comision + IVA: {{ item.monto|currency }}</div>
                    <div class="kanban-honorarios">No. factura honorarios: {{ item.num_factura_honorarios|default_if_none:"" }}</div>
                    <a class="btn-detalle" href="{% url 'dispersiones_edit' item.id %}?mes={{ mes }}&anio={{ anio }}&next={{ request.get_full_path|urlencode }}">Detalle</a>
                  </div>
                </div>
              {% endfor %}
            {% else %}
              <div class="kanban-empty">Sin registros</div>
            {% endif %}
          </details>
        {% endfor %}
      </div>
    {% empty %}
      <div class="kanban-empty">Sin dispersiones</div>
    {% endfor %}
  </div>
{% endblock %}
