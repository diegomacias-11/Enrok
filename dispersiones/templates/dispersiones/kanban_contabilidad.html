{% extends "kanban_base.html" %}
{% load cliente_extras %}

{% block title %}Facturas (Kanban){% endblock %}

{% block filtros %}
  <div class="filter-title">{{ mes_nombre|default_if_none:"" }} {{ anio|default_if_none:"" }}</div>
  <div class="filter-bar">
    <div class="filter-slot filter-slot-left">
      <a class="btn-primary btn-primary-inline btn-view" href="{% url 'dispersiones_list' %}?mes={{ mes }}&anio={{ anio }}">Vista</a>
    </div>
    <div class="filter-slot filter-slot-center">
      <form method="get" class="filter-form-simple kanban-filter dispersiones-filter">
        <div class="filter-block">
          <label for="mes">Mes</label>
          <select id="mes" name="mes">
            {% if meses_choices %}
              {% for m, nombre in meses_choices %}
                <option value="{{ m }}" {% if mes == m|stringformat:'i' %}selected{% endif %}>{{ nombre }}</option>
              {% endfor %}
            {% else %}
              {% for m in meses %}
                <option value="{{ m }}" {% if mes == m|stringformat:'i' %}selected{% endif %}>{{ m|stringformat:"02d" }}</option>
              {% endfor %}
            {% endif %}
          </select>
        </div>
        <span class="filter-separator" aria-hidden="true"></span>
        <div class="filter-block">
          <label for="anio">AÃ±o</label>
          <input type="number" id="anio" name="anio" value="{{ anio|default_if_none:'' }}" min="2000" max="2100">
        </div>
        <span class="filter-separator" aria-hidden="true"></span>
        <div class="filter-block">
          <label for="f_cliente">Cliente</label>
          <select id="f_cliente" name="cliente">
            <option value="">Todos</option>
            {% for c in clientes %}
              <option value="{{ c.id }}" {% if f_cliente == c.id|stringformat:'i' %}selected{% endif %}>{{ c.razon_social|default_if_none:"" }} - {{ c.get_servicio_display|default_if_none:"" }}</option>
            {% endfor %}
          </select>
        </div>
        <span class="filter-separator" aria-hidden="true"></span>
        <div class="filter-actions">
          <button type="submit" class="btn-filter">Filtrar</button>
          <a href="{% url 'dispersiones_kanban_contabilidad' %}?mes={{ mes }}&anio={{ anio }}" class="btn-filter">Limpiar</a>
        </div>
      </form>
    </div>
    <div class="filter-slot filter-slot-right"></div>
  </div>
{% endblock %}


{% block kanban_content %}
  <div class="kanban-board">
    {% for bloque in kanban_data %}
      <div class="kanban-column {% if bloque.status_class %}{{ bloque.status_class }}{% endif %}">
        <div class="kanban-column-title">
          <button type="button" class="btn-filter btn-expand-toggle" data-action="toggle">Extender</button>
          <span class="kanban-column-name">{{ bloque.titulo }}</span>
          <span class="kanban-column-count">Total: {{ bloque.card_count }}</span>
        </div>
        {% for grupo in bloque.clientes %}
          <details class="kanban-area">
            <summary class="kanban-area-title kanban-area-title-bar"><span class="kanban-area-name">{{ grupo.cliente }}</span><span class="kanban-area-count">Total: {{ grupo.card_count }}</span></summary>
            {% if grupo.items %}
              {% for item in grupo.items %}
                <div class="kanban-card">
                  <div class="kanban-card-body">
                    <div class="kanban-task">{{ item.fecha|date:"d/m/Y" }}</div>
                    <div class="kanban-meta">Comision + IVA: {{ item.monto|currency }}</div>
                    <div class="kanban-meta">Forma de pago: {{ item.forma_pago|default_if_none:"" }}</div>
                    <div class="kanban-honorarios">No. factura honorarios: {{ item.num_factura_honorarios|default_if_none:"" }}</div>
                    <a class="btn-detalle" href="{% url 'dispersiones_edit' item.id %}?mes={{ mes }}&anio={{ anio }}&next={{ request.get_full_path|urlencode }}">Detalle</a>
                  </div>
                </div>
              {% endfor %}
            {% else %}
              <div class="kanban-empty">Sin registros</div>
            {% endif %}
          </details>
        {% endfor %}
      </div>
    {% empty %}
      <div class="kanban-empty">Sin dispersiones</div>
    {% endfor %}
  </div>
  <script>
    (function () {
      function toggleColumn(button) {
        var column = button.closest(".kanban-column");
        if (!column) {
          return;
        }
        var details = column.querySelectorAll("details.kanban-area");
        if (!details.length) {
          return;
        }
        var shouldOpen = button.textContent.trim().toLowerCase() === "extender";
        details.forEach(function (el) {
          el.open = shouldOpen;
        });
        button.textContent = shouldOpen ? "Retraer" : "Extender";
      }

      document.querySelectorAll(".btn-expand-toggle").forEach(function (button) {
        button.addEventListener("click", function () {
          toggleColumn(button);
        });
      });
    })();
  </script>
{% endblock %}
