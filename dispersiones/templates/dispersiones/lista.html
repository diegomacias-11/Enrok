{% extends "lista.html" %}
{% load cliente_extras %}
{% load group_tags %}

{% block title %}{% if is_contabilidad %}Facturas{% else %}Dispersiones{% endif %}{% endblock %}

{% block filtros %}
  <div class="filter-title">{{ mes_nombre|default_if_none:"" }} {{ anio|default_if_none:"" }}</div>
  <div class="filter-bar">
    <div class="filter-slot filter-slot-left">
      {% if not is_contabilidad %}
        {% if user.is_superuser or user|has_group:"Dirección Operaciones" or user|has_group:"Direccion Operaciones" %}
          <a class="btn-primary btn-primary-inline btn-view" href="{% url 'dispersiones_kanban' %}?mes={{ mes }}&anio={{ anio }}">Vista</a>
        {% endif %}
      {% endif %}
    </div>
    <div class="filter-slot filter-slot-center">
      <form action="{% url 'dispersiones_list' %}" method="get" class="filter-form-simple dispersiones-filter">
        <div class="filter-block">
          <label for="mes">Mes</label>
          <select id="mes" name="mes">
            {% if meses_choices %}
              {% for m, nombre in meses_choices %}
                <option value="{{ m }}" {% if mes == m|stringformat:'i' %}selected{% endif %}>{{ nombre }}</option>
              {% endfor %}
            {% else %}
              {% for m in meses %}
                <option value="{{ m }}" {% if mes == m|stringformat:'i' %}selected{% endif %}>{{ m|stringformat:"02d" }}</option>
              {% endfor %}
            {% endif %}
          </select>
        </div>
        <span class="filter-separator" aria-hidden="true"></span>
        <div class="filter-block">
          <label for="anio">Año</label>
          <input type="number" id="anio" name="anio" value="{{ anio|default_if_none:'' }}" min="2000" max="2100">
        </div>
        {% if not is_contabilidad %}
          <span class="filter-separator" aria-hidden="true"></span>
          <div class="filter-block">
            <label for="f_cliente">Cliente</label>
            <select id="f_cliente" name="cliente">
              <option value="">Todos</option>
              {% for c in clientes %}
                <option value="{{ c.id }}" {% if f_cliente == c.id|stringformat:'i' %}selected{% endif %}>{{ c.razon_social }}</option>
              {% endfor %}
            </select>
          </div>
          {% if not is_ejecutivo %}
            <span class="filter-separator" aria-hidden="true"></span>
            <div class="filter-block">
              <label for="f_ejecutivo">Ejecutivo</label>
              <select id="f_ejecutivo" name="ejecutivo">
                <option value="">Todos</option>
                {% for id, name in ejecutivos %}
                  <option value="{{ id }}" {% if f_ejecutivo == id|stringformat:'i' %}selected{% endif %}>{{ name }}</option>
                {% endfor %}
              </select>
            </div>
            <span class="filter-separator" aria-hidden="true"></span>
            <div class="filter-block">
              <label for="f_factura_solicitada">Factura solicitada</label>
              <select id="f_factura_solicitada" name="factura_solicitada">
                <option value="">Todos</option>
                <option value="1" {% if f_factura_solicitada == "1" %}selected{% endif %}>Sí</option>
                <option value="0" {% if f_factura_solicitada == "0" %}selected{% endif %}>No</option>
              </select>
            </div>
          {% endif %}
        {% endif %}
        <span class="filter-separator" aria-hidden="true"></span>
        <div class="filter-actions">
          <button type="submit" class="btn-filter">Filtrar</button>
          <a href="{% url 'dispersiones_list' %}?mes={{ mes }}&anio={{ anio }}" class="btn-filter">Limpiar</a>
        </div>
      </form>
    </div>
    <div class="filter-slot filter-slot-right">
      {% if not is_contabilidad %}
        <a href="{% url 'dispersiones_add' %}?mes={{ mes }}&anio={{ anio }}&next={{ request.get_full_path|urlencode }}" class="btn-primary btn-primary-inline">Nueva dispersión</a>
      {% endif %}
    </div>
  </div>
{% endblock %}






{% block tabla_head %}
  {% if is_contabilidad %}
    <tr>
      <th class="sticky-1 col-actions">Acciones</th>
      <th class="sticky-2 col-fecha">Fecha</th>
      <th class="sticky-3">Cliente</th>
      <th>Comisión (%)</th>
      <th>Monto dispersión</th>
      <th>Monto comisión</th>
      <th>Comisión + IVA</th>
      <th>Facturadora</th>
      <th>Forma de pago</th>
      <th>No. factura honorarios</th>
    </tr>
  {% else %}
    <tr>
      <th class="sticky-1 col-actions">Acciones</th>
      <th class="sticky-2 col-fecha">Fecha</th>
      <th class="sticky-3">Cliente</th>
      <th>No. periodo</th>
      <th>Servicio</th>
      <th>Comisión (%)</th>
      {% if not is_ejecutivo %}
      <th>Ejecutivo</th>
      {% endif %}
      <th>Monto dispersión</th>
      <th>Monto comisión</th>
      <th>Comisión + IVA</th>
      <th>AC</th>
      <th>No. factura</th>
      <th>Facturadora</th>
      <th>No. factura honorarios</th>
      <th>Estatus proceso</th>
      <th>Estatus periodo</th>
      <th>Estatus pago</th>
      <th>Factura solicitada</th>
      <th>Comentarios</th>
    </tr>
  {% endif %}
{% endblock %}



{% block tabla_body %}
  {% for d in dispersiones %}
    <tr>
      <td class="sticky-1 col-actions"><a class="btn-detalle" href="{% url 'dispersiones_edit' d.id %}?mes={{ mes }}&anio={{ anio }}&next={{ request.get_full_path|urlencode }}">Editar</a></td>
      <td class="sticky-2 col-fecha">{{ d.fecha|date:"d/m/Y"|default_if_none:"" }}</td>
      <td class="sticky-3">{{ d.cliente.razon_social|default_if_none:"" }}</td>
      {% if is_contabilidad %}
        <td>{{ d.comision_porcentaje|floatformat:2 }}%</td>
        <td>{{ d.monto_dispersion|currency }}</td>
        <td>{{ d.monto_comision|currency }}</td>
        <td>{{ d.monto_comision_iva|currency }}</td>
        <td>{{ d.facturadora|default_if_none:"" }}</td>
        <td>{{ d.get_forma_pago_display|default_if_none:"" }}</td>
        <td>{{ d.num_factura_honorarios|default_if_none:"" }}</td>
      {% else %}
        <td>{{ d.num_periodo|default_if_none:"" }}</td>
        <td>{{ d.servicio|default_if_none:"" }}</td>
        <td>{{ d.comision_porcentaje|floatformat:2 }}%</td>
        {% if not is_ejecutivo %}
        <td>
          {% with e1=d.ejecutivo %}
            {% if e1 %}{{ e1.get_full_name|default:e1.username }}{% endif %}
          {% endwith %}
        </td>
        {% endif %}
        <td>{{ d.monto_dispersion|currency }}</td>
        <td>{{ d.monto_comision|currency }}</td>
        <td>{{ d.monto_comision_iva|currency }}</td>
        <td>{{ d.cliente.get_ac_display|default_if_none:"" }}</td>
        <td>{{ d.num_factura|default_if_none:"" }}</td>
        <td>{{ d.facturadora|default_if_none:"" }}</td>
        <td>{{ d.num_factura_honorarios|default_if_none:"" }}</td>
        <td>{{ d.estatus_proceso|default_if_none:"" }}</td>
        <td>{{ d.estatus_periodo|default_if_none:"" }}</td>
        <td>{{ d.estatus_pago|default_if_none:"" }}</td>
        <td class="text-center">
          <input type="checkbox" {% if d.factura_solicitada %}checked{% endif %} disabled>
        </td>
        <td>{{ d.comentarios|default_if_none:"" }}</td>
      {% endif %}
    </tr>
  {% empty %}
    <tr><td colspan="{% if is_contabilidad %}10{% elif not is_ejecutivo %}19{% else %}18{% endif %}">Sin dispersiones en el periodo.</td></tr>
  {% endfor %}
{% endblock %}

