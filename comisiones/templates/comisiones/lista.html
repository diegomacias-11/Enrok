{% extends "lista.html" %}
{% load cliente_extras %}

{% block title %}Comisiones{% endblock %}

{% block filtros %}
  <div class="filter-title">{{ mes_nombre|default_if_none:"" }} {{ anio|default_if_none:"" }}</div>
  <div class="metrics-row">
    <div class="metric">
      <div class="metric-label">Total periodo</div>
      <div class="metric-value">{{ total_periodo|default_if_none:""|currency }}</div>
    </div>
    <div class="metric">
      <div class="metric-label">Liberado</div>
      <div class="metric-value">{{ total_liberado|default_if_none:""|currency }}</div>
    </div>
    <div class="metric">
      <div class="metric-label">Pagos</div>
      <div class="metric-value">{{ total_pagos|default_if_none:""|currency }}</div>
    </div>
    <div class="metric">
      <div class="metric-label">Pendiente</div>
      <div class="metric-value">{{ total_pendiente|default_if_none:""|currency }}</div>
    </div>
  </div>
  <form action="{% url 'comisiones_list' %}" method="get" class="filter-form-simple comisiones-filter dispersiones-filter">
    <div class="filter-block">
      <label for="mes">Mes</label>
      <select id="mes" name="mes">
        {% if meses_choices %}
          {% for m, nombre in meses_choices %}
            <option value="{{ m }}" {% if mes == m|stringformat:'i' %}selected{% endif %}>{{ nombre }}</option>
          {% endfor %}
        {% else %}
          {% for m in meses %}
            <option value="{{ m }}" {% if mes == m|stringformat:'i' %}selected{% endif %}>{{ m|stringformat:"02d" }}</option>
          {% endfor %}
        {% endif %}
      </select>
    </div>
    <span class="filter-separator" aria-hidden="true"></span>
    <div class="filter-block">
      <label for="anio">AÃ±o</label>
      <input type="number" id="anio" name="anio" value="{{ anio|default_if_none:'' }}" min="2000" max="2100">
    </div>
    <span class="filter-separator" aria-hidden="true"></span>
    <div class="filter-block">
      <label for="f_cliente">Cliente</label>
      <select id="f_cliente" name="cliente">
        <option value="">Todos</option>
        {% for c in clientes %}
          <option value="{{ c.id }}" {% if f_cliente == c.id|stringformat:'i' %}selected{% endif %}>{{ c.razon_social|default_if_none:"" }} - {{ c.get_servicio_display|default_if_none:"" }}</option>
        {% endfor %}
      </select>
    </div>
    <span class="filter-separator" aria-hidden="true"></span>
    <div class="filter-actions">
      <button type="submit" class="btn-filter">Filtrar</button>
      <a href="{% url 'comisiones_list' %}?mes={{ mes }}&anio={{ anio }}" class="btn-filter">Limpiar</a>
    </div>
  </form>
  <a href="{% url 'comisiones_pago_add' %}?mes={{ mes }}&anio={{ anio }}" class="btn-primary">Registrar pago</a>
{% endblock %}

{% block tabla_head %}
  <tr>
    <th class="sticky-1 col-actions">Acciones</th>
    <th class="sticky-2">Comisionista</th>
    <th>Total periodo</th>
    <th>Liberadas</th>
    <th>Pagos</th>
    <th>Pendiente</th>
  </tr>
{% endblock %}

{% block tabla_body %}
  {% for r in resumen %}
    <tr>
      <td class="sticky-1 col-actions">
        <a class="btn-detalle" href="{% url 'comisiones_detail' r.comisionista_id %}?mes={{ mes }}&anio={{ anio }}">Detalle</a>
      </td>
      <td class="sticky-2">{{ r.comisionista__nombre|default_if_none:"" }}</td>
      <td>{{ r.total|default_if_none:""|currency }}</td>
      <td>{{ r.liberadas|default_if_none:""|currency }}</td>
      <td>{% if r.pagos and r.pagos != 0 %}{{ r.pagos|currency }}{% endif %}</td>
      <td>{{ r.pendiente|default_if_none:""|currency }}</td>
    </tr>
  {% empty %}
    <tr><td colspan="6">Sin comisiones en el periodo.</td></tr>
  {% endfor %}
{% endblock %}
